<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IAT – Brand Preference (Final)</title>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-survey-html-form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial;
      padding: 2em;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .jspsych-content {
      max-width: 800px;
      font-size: 18px;
    }
    #results {
      margin-top: 20px;
      padding: 1em;
      background: #e6ffe6;
      border-radius: 8px;
      display: none;
      position: relative;
      z-index: 1000;
      text-align: center;
    }
    .welcome-container {
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      background: #ffffff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 20px auto;
      max-width: 700px;
    }
    .welcome-box {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      background: #f8f8f8;
      text-align: center;
    }
    .table-box {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      background: #f8f8f8;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 0 auto;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <div id="results"></div>
  <script>
    const familiar = ['Nike', 'Coca-Cola', 'Apple', 'Adidas', 'Pepsi'];
    const unfamiliar = ['Zyxel', 'Qdoba', 'Vuzix', 'Yuneec', 'Kudelski'];
    const trustworthy = ['Reliable', 'Quality', 'Trustworthy', 'Dependable', 'Reputable'];
    const nonReliable = ['Unreliable', 'Cheap', 'Risky', 'Faulty', 'Unstable'];

    const userData = {
      id: 'P-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
      demographics: {},
      trials: [],
      dScore: null
    };

    const timeline = [];

    // Welcome
    timeline.push({
      type: 'html-button-response',
      stimulus: `
        <div class="welcome-container">
          <div class="welcome-box">
            <h2>Implicit Association Test</h2>
            <p>Next, you will use the 'E' and 'I' keys on your keyboard to categorize items into groups as fast as you can.</p>
          </div>
          <div class="table-box">
            <table>
              <tr><th>Category</th><th>Items</th></tr>
              <tr><td>Familiar</td><td>${familiar.join(', ')}</td></tr>
              <tr><td>Unfamiliar</td><td>${unfamiliar.join(', ')}</td></tr>
              <tr><td>Trustworthy</td><td>${trustworthy.join(', ')}</td></tr>
              <tr><td>Non-reliable</td><td>${nonReliable.join(', ')}</td></tr>
            </table>
          </div>
          <div class="welcome-box">
            <p>There are six parts. The instructions change for each part. Pay attention!</p>
            <p style="margin-top: 2em; font-style: italic;">· Project Implicit ·</p>
          </div>
        </div>
      `,
      choices: ['Begin']
    });

    // Demographics
    timeline.push({
      type: 'survey-html-form',
      preamble: '<h3>Demographic Information</h3>',
      html: `
        <p>Gender: <select name="gender" required><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></p>
        <p>Age Group: <select name="age" required><option value="">Select</option><option>20–24</option><option>25–29</option><option>30–34</option><option>35–39</option><option>40+</option></select></p>
        <p>Occupation: <select name="occupation" required><option value="">Select</option><option>Student</option><option>Engineer</option><option>Teacher</option><option>Healthcare Professional</option><option>Business Professional</option><option>Other</option></select></p>
        <p>Education: <select name="education" required><option value="">Select</option><option>High School</option><option>Bachelor's</option><option>Master's</option><option>Doctorate</option><option>Other</option></select></p>
      `,
      on_finish: data => {
        console.log('Demographics submitted:', JSON.parse(data.responses));
        userData.demographics = JSON.parse(data.responses);
      }
    });

    // Dummy block to confirm progression
    timeline.push({
      type: 'html-button-response',
      stimulus: '<p>Demographics completed. Proceeding to trials...</p>',
      choices: ['Continue']
    });

    // Trial builder
    function addTrial(word, left, right, block, correctLeft) {
      return {
        type: 'html-keyboard-response',
        stimulus: `
          <div style="font-size: 20px; margin-bottom: 20px;">
            ${left} (E)                    ${right} (I)
          </div>
          <p style="font-size: 32px;">${word}</p>
        `,
        choices: ['e', 'i'],
        data: { word, block, correct: correctLeft ? 'e' : 'i' },
        trial_duration: 2000,
        response_ends_trial: true,
        post_trial_gap: 500,
        on_finish: data => {
          const correct = data.response === data.correct ? 1 : 0;
          userData.trials.push({ word: data.word, block: data.block, rt: data.rt, correct, timestamp: new Date().toISOString() });
          console.log('Trial recorded:', userData.trials[userData.trials.length - 1]);
        }
      };
    }

    // Instructions for each block
    function addInstructions(text) {
      return {
        type: 'html-button-response',
        stimulus: `<p>${text}</p>`,
        choices: ['Continue']
      };
    }

    // Blocks
    timeline.push(addInstructions("Categorize brands as Familiar (E) or Unfamiliar (I)."));
    timeline.push(...familiar.slice(0, 5).map(w => addTrial(w, 'Familiar', 'Unfamiliar', 'familiar', true)));
    timeline.push(...unfamiliar.slice(0, 5).map(w => addTrial(w, 'Familiar', 'Unfamiliar', 'unfamiliar', false)));

    timeline.push(addInstructions("Categorize attributes as Trustworthy (E) or Non-reliable (I)."));
    timeline.push(...trustworthy.slice(0, 5).map(w => addTrial(w, 'Trustworthy', 'Non-reliable', 'trustworthy', true)));
    timeline.push(...nonReliable.slice(0, 5).map(w => addTrial(w, 'Trustworthy', 'Non-reliable', 'non-reliable', false)));

    timeline.push(addInstructions("Categorize as Familiar/Trustworthy (E) or Unfamiliar/Non-reliable (I)."));
    const congruent = [
      ...familiar.slice(0, 3), ...trustworthy.slice(0, 2),
      ...unfamiliar.slice(0, 3), ...nonReliable.slice(0, 2)
    ];
    jsPsych.randomization.shuffle(congruent).forEach(w => {
      const isFamiliarTrust = familiar.includes(w) || trustworthy.includes(w);
      timeline.push(addTrial(w, 'Familiar/Trustworthy', 'Unfamiliar/Non-reliable', 'congruent', isFamiliarTrust));
    });

    timeline.push(addInstructions("Categorize as Unfamiliar/Non-reliable (E) or Familiar/Trustworthy (I)."));
    const incongruent = [
      ...familiar.slice(0, 3), ...trustworthy.slice(0, 2),
      ...unfamiliar.slice(0, 3), ...nonReliable.slice(0, 2)
    ];
    jsPsych.randomization.shuffle(incongruent).forEach(w => {
      const isFamiliarTrust = familiar.includes(w) || trustworthy.includes(w);
      timeline.push(addTrial(w, 'Unfamiliar/Non-reliable', 'Familiar/Trustworthy', 'incongruent', !isFamiliarTrust));
    });

    // D-score calculation
    timeline.push({
      type: 'call-function',
      func: function() {
        const cRT = userData.trials.filter(t => t.block === 'congruent').map(t => t.rt);
        const iRT = userData.trials.filter(t => t.block === 'incongruent').map(t => t.rt);
        const mean = a => a.reduce((x, y) => x + y, 0) / (a.length || 1);
        const sd = a => {
          const m = mean(a);
          return a.length > 1 ? Math.sqrt(a.reduce((sum, v) => sum + (v - m) ** 2, 0) / (a.length - 1)) : 1;
        };
        const pooledSD = sd([...cRT, ...iRT]);
        const d = ((mean(iRT) - mean(cRT)) / pooledSD) || 0;
        userData.dScore = d.toFixed(3);
        console.log('Computed D-Score:', userData.dScore);
      }
    });

    // Submission
    timeline.push({
      type: 'call-function',
      func: function() {
        console.log('Sending payload to server:', userData);
        return fetch('https://script.google.com/macros/s/AKfycbzjnA81tgjk3feNwADnMpI_ePzquEY9WjuDvlAHNs-okWLcFR4RAp2actklk3zj4vVX3A/exec', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(userData)
        })
        .then(response => {
          console.log('Fetch response status:', response.status, response.statusText);
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} (${response.statusText})`);
          return response.text();
        })
        .then(text => {
          console.log('Server response text:', text || 'No response text received');
          document.getElementById('results').style.display = 'block';
          document.getElementById('results').innerHTML = `
            <h3>Thank You!</h3>
            <p>Your D-Score: <strong>${userData.dScore}</strong></p>
            <p>(Positive = Familiarity/Trustworthiness Bias)</p>
            <p>Your responses have been submitted.</p>`;
        })
        .catch(err => {
          console.error('Error sending data:', err.message);
          document.getElementById('results').style.display = 'block';
          document.getElementById('results').innerHTML = `
            <h3>Error</h3>
            <p>Submission failed: ${err.message}</p>`;
        });
      }
    });

    // Final screen
    timeline.push({
      type: 'html-button-response',
      stimulus: '<p>Press Finish to end the study.</p>',
      choices: ['Finish']
    });

    jsPsych.init({ timeline, display_element: 'jspsych-target', show_progress_bar: true });
  </script>
</body>
</html>
