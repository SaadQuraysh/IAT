<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IAT – Brand Preference (Final)</title>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-survey-html-form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial; padding: 2em; background: #f9f9f9; display: flex; flex-direction: column; align-items: center; }
    .jspsych-content { max-width: 800px; font-size: 18px; }
    #results { margin-top: 20px; padding: 1em; background: #e6ffe6; border-radius: 8px; display: none; }
  </style>
</head>
<body>
<div id="jspsych-target"></div>
<div id="results"></div>
<script>
const familiar = ['Nike', 'Coca-Cola', 'Apple', 'Adidas', 'Pepsi'];
const unfamiliar = ['Zyxel', 'Qdoba', 'Vuzix', 'Yuneec', 'Kudelski'];
const trustworthy = ['Reliable', 'Quality', 'Trustworthy', 'Dependable', 'Reputable'];
const nonReliable = ['Unreliable', 'Cheap', 'Risky', 'Faulty', 'Unstable'];

const userData = {
  id: 'P-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
  demographics: {},
  trials: [],
  dScore: null
};

const timeline = [];

// Welcome
timeline.push({
  type: 'html-button-response',
  stimulus: `
    <h2>Implicit Association Test</h2>
    <p>Next, you will use on-screen buttons (or 'E' and 'I' keys on keyboard) to categorize items into groups as fast as you can.</p>
    <table border="1" cellpadding="10">
      <tr><th>Category</th><th>Items</th></tr>
      <tr><td>Familiar</td><td>Nike, Coca-Cola, Apple, Adidas, Pepsi</td></tr>
      <tr><td>Unfamiliar</td><td>Zyxel, Qdoba, Vuzix, Yuneec, Kudelski</td></tr>
      <tr><td>Trustworthy</td><td>Reliable, Quality, Trustworthy, Dependable, Reputable</td></tr>
      <tr><td>Non-reliable</td><td>Unreliable, Cheap, Risky, Faulty, Unstable</td></tr>
    </table>
    <p>There are six parts. The instructions change for each part. Pay attention!</p>
    <p style="margin-top: 2em; font-style: italic;">· Project Implicit ·</p>
  `,
  choices: ['Begin']
});
  
// Demographics
timeline.push({
  type: 'survey-html-form',
  preamble: '<h3>Demographic Information</h3>',
  html: `
    <p>Gender: <select name="gender" required><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></p>
    <p>Age Group: <select name="age" required><option value="">Select</option><option>20–24</option><option>25–29</option><option>30–34</option><option>35–39</option><option>40+</option></select></p>
     <p>Occupation: <select name="occupation" required><option value="">Select</option><option>Student</option><option>Engineer</option><option>Teacher</option><option>Healthcare Professional</option><option>Business Professional</option><option>Other</option>
    <p>Education: <select name="education" required><option value="">Select</option><option>High School</option><option>Bachelor's</option><option>Master's</option><option>Doctorate</option><option>Other</option></select></p>
  `,
  on_finish: data => {
    userData.demographics = JSON.parse(data.responses);
  }
});

// Trial builder
  timeline.push({
function addTrial(word, left, right, block, correctLeft) {
  return {
    type: 'html-button-response',
    stimulus: `<p style="font-size:32px;">${word}</p>`,
    choices: [left, right],
    data: { word, block, correct: correctLeft ? left : right },
    on_finish: data => {
      const correct = data.response === data.correct ? 1 : 0;
      userData.trials.push({ word: data.word, block: data.block, rt: data.rt, correct });
    }
  };
}

// Blocks
timeline.push(...familiar.slice(0, 5).map(w => addTrial(w, 'Familiar', 'Unfamiliar', 'familiar', true)));
timeline.push(...unfamiliar.slice(0, 5).map(w => addTrial(w, 'Familiar', 'Unfamiliar', 'unfamiliar', false)));
timeline.push(...trustworthy.slice(0, 5).map(w => addTrial(w, 'Trustworthy', 'Non-reliable', 'trustworthy', true)));
timeline.push(...nonReliable.slice(0, 5).map(w => addTrial(w, 'Trustworthy', 'Non-reliable', 'non-reliable', false)));

// Congruent (Familiar/Trust vs. Unfamiliar/Non-reliable)
const congruent = [
  ...familiar.slice(0, 3), ...trustworthy.slice(0, 2),
  ...unfamiliar.slice(0, 3), ...nonReliable.slice(0, 2)
];
jsPsych.randomization.shuffle(congruent).forEach(w => {
  const isFamiliarTrust = familiar.includes(w) || trustworthy.includes(w);
  timeline.push(addTrial(w, 'Familiar/Trustworthy', 'Unfamiliar/Non-reliable', 'congruent', isFamiliarTrust));
});

// Incongruent (Reverse mapping)
const incongruent = [
  ...familiar.slice(0, 3), ...trustworthy.slice(0, 2),
  ...unfamiliar.slice(0, 3), ...nonReliable.slice(0, 2)
];
jsPsych.randomization.shuffle(incongruent).forEach(w => {
  const isFamiliarTrust = familiar.includes(w) || trustworthy.includes(w);
  timeline.push(addTrial(w, 'Unfamiliar/Non-reliable', 'Familiar/Trustworthy', 'incongruent', !isFamiliarTrust));
});

// Submit + D-score
timeline.push({
  type: 'html-button-response',
  stimulus: '<p>Test complete. Tap Submit to continue.</p>',
  choices: ['Submit'],
  on_finish: () => {
    const cRT = userData.trials.filter(t => t.block === 'congruent').map(t => t.rt);
    const iRT = userData.trials.filter(t => t.block === 'incongruent').map(t => t.rt);
    const mean = a => a.reduce((x, y) => x + y, 0) / a.length;
    const sd = a => {
      const m = mean(a);
      return Math.sqrt(a.reduce((sum, v) => sum + (v - m) ** 2, 0) / (a.length - 1));
    };
    const pooledSD = sd([...cRT, ...iRT]);
    const d = ((mean(iRT) - mean(cRT)) / pooledSD) || 0;
    userData.dScore = d.toFixed(3);

    fetch('https://script.google.com/macros/s/AKfycbzjnA81tgjk3feNwADnMpI_ePzquEY9WjuDvlAHNs-okWLcFR4RAp2actklk3zj4vVX3A/exec', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(userData)
    })
    .then(() => {
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').innerHTML = `
        <h3>Thank You!</h3>
        <p>Your D-Score: <strong>${userData.dScore}</strong></p>
        <p>Your responses have been submitted.</p>`;
    })
    .catch(err => {
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').innerHTML = '<h3>Error</h3><p>Submission failed.</p>';
      console.error(err);
    });
  }
});

// Final screen
timeline.push({
  type: 'html-button-response',
  stimulus: '<p>Press Finish to end the study.</p>',
  choices: ['Finish']
});

jsPsych.init({ timeline, display_element: 'jspsych-target' });
</script>
</body>
</html>
