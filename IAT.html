<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IAT Brand Preference</title>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-survey-html-form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-categorize-html.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .jspsych-content { max-width: 800px; margin: auto; }
  </style>
</head>
<body>
<script>
  const familiar = ['Nike', 'Coca-Cola', 'Apple', 'Adidas', 'Pepsi'];
  const unfamiliar = ['Zyxel', 'Qdoba', 'Vuzix', 'Yuneec', 'Kudelski'];
  const trustworthy = ['Reliable', 'Quality', 'Trustworthy', 'Dependable', 'Reputable'];
  const nonReliable = ['Unreliable', 'Cheap', 'Risky', 'Faulty', 'Unstable'];

  const jsPsych = initJsPsych({
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });

  let participantData = {};

  const welcome = {
    type: 'html-button-response',
    stimulus: `
      <h2>Welcome to the IAT</h2>
      <p>This test takes about 5â€“7 minutes and helps us study unconscious brand associations.</p>
      <p><strong>Categories:</strong></p>
      <p><strong>Familiar:</strong> Nike, Coca-Cola, Apple, Adidas, Pepsi<br>
         <strong>Unfamiliar:</strong> Zyxel, Qdoba, Vuzix, Yuneec, Kudelski<br>
         <strong>Trustworthy:</strong> Reliable, Quality, Trustworthy, Dependable, Reputable<br>
         <strong>Non-reliable:</strong> Unreliable, Cheap, Risky, Faulty, Unstable</p>
      <p>Try to categorize items as quickly and accurately as possible.</p>
    `,
    choices: ['Start']
  };

  const demographics = {
    type: 'survey-html-form',
    html: `
      <label>Gender:<br><select name="gender" required>
        <option value="">Select</option><option>Male</option><option>Female</option><option>Other</option>
      </select></label><br><br>
      <label>Age:<br><input type="number" name="age" min="10" max="99" required></label><br><br>
      <label>Occupation:<br><input type="text" name="occupation" required></label><br><br>
      <label>Education:<br><select name="education" required>
        <option value="">Select</option><option>High School</option><option>Undergraduate</option>
        <option>Graduate</option><option>Postgraduate</option>
      </select></label><br><br>
      <label>Ethnicity:<br><select name="ethnicity" required>
        <option value="">Select</option>
        <option>Asian</option><option>Black or African American</option>
        <option>Hispanic or Latino</option><option>White</option>
        <option>Other</option>
      </select></label><br><br>
      <input type="submit" value="Continue">
    `,
    on_finish: function(data) {
      participantData = JSON.parse(data.responses);
    }
  };

  function createCategorizeTrial(word, correct_category, categories) {
    return {
      type: 'categorize-html',
      stimulus: `<div style='font-size:40px;'>${word}</div>`,
      key_answer: correct_category === categories[0] ? 'e' : 'i',
      choices: ['e', 'i'],
      prompt: `<p>Press 'E' for ${categories[0]}<br>Press 'I' for ${categories[1]}</p>`,
      show_stim_with_feedback: true,
      data: { stimulus: word, category: correct_category }
    };
  }

  function getIATBlock(cat1, cat2, label1, label2, words1, words2) {
    const trials = [];
    const allWords = [...words1.map(w => [w, cat1]), ...words2.map(w => [w, cat2])];
    jsPsych.randomization.shuffle(allWords).forEach(([word, cat]) => {
      trials.push(createCategorizeTrial(word, cat, [label1, label2]));
    });
    return trials;
  }

  const iat_blocks = [
    ...getIATBlock('Familiar', 'Unfamiliar', 'Familiar', 'Unfamiliar', familiar, unfamiliar),
    ...getIATBlock('Trustworthy', 'NonReliable', 'Trustworthy', 'NonReliable', trustworthy, nonReliable),
    ...getIATBlock('Familiar+Trustworthy', 'Unfamiliar+NonReliable', 'Familiar+Trustworthy', 'Unfamiliar+NonReliable', familiar.concat(trustworthy), unfamiliar.concat(nonReliable)),
    ...getIATBlock('Familiar+NonReliable', 'Unfamiliar+Trustworthy', 'Familiar+NonReliable', 'Unfamiliar+Trustworthy', familiar.concat(nonReliable), unfamiliar.concat(trustworthy)),
  ];

  const thank_you = {
    type: 'html-button-response',
    stimulus: '<h3>Thank you for contributing to our research!</h3>',
    choices: ['Finish']
  };

  const send_data = {
    type: 'call-function',
    func: function() {
      const iatData = jsPsych.data.get().filter({trial_type: 'categorize-html'}).values();
      const correctRTs = iatData.filter(d => d.correct === true).map(d => d.rt);
      const dScore = (correctRTs.length > 0) ? (correctRTs.reduce((a, b) => a + b) / correctRTs.length) : 0;
      const payload = {
        timestamp: new Date().toISOString(),
        gender: participantData.gender,
        age: participantData.age,
        occupation: participantData.occupation,
        education: participantData.education,
        ethnicity: participantData.ethnicity,
        dScore: dScore
      };
      fetch('https://script.google.com/macros/s/AKfycbzjnA81tgjk3feNwADnMpI_ePzquEY9WjuDvlAHNs-okWLcFR4RAp2actklk3zj4vVX3A/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
    }
  };

  jsPsych.run([
    welcome,
    demographics,
    ...iat_blocks,
    send_data,
    thank_you
  ]);
</script>
</body>
</html>
