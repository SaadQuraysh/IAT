<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Implicit Association Test (Mobile Friendly)</title>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/plugins/jspsych-survey-html-form.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-call-function@1.1.1"></script>
  <link href="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    .welcome-container { max-width: 600px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    .error-message { color: red; font-weight: bold; margin-top: 1em; }
    @media (max-width: 480px) {
      body { font-size: 16px; }
      table, th, td { font-size: 14px; }
    }
  </style>
</head>
<body>
<div id="jspsych-target"></div>
<script>
(async function() {
  const familiar = ['Nike', 'Coca-Cola', 'Apple', 'Adidas', 'Pepsi'];
  const unfamiliar = ['Zyxel', 'Qdoba', 'Vuzix', 'Yuneec', 'Kudelski'];
  const trustworthy = ['Reliable', 'Quality', 'Trustworthy', 'Dependable', 'Reputable'];
  const nonReliable = ['Unreliable', 'Cheap', 'Risky', 'Faulty', 'Unstable'];

  const shuffle = arr => arr.map(value => ({ value, sort: Math.random() }))
                           .sort((a, b) => a.sort - b.sort)
                           .map(({ value }) => value);

  const welcome = {
    type: 'html-keyboard-response',
    stimulus: `
      <div class="welcome-container">
        <h2>Implicit Association Test</h2>
        <p>Use 'E' (left) and 'I' (right) keys to categorize items. Tap left/right on mobile.</p>
        <table>
          <tr><th>Category</th><th>Items</th></tr>
          <tr><td>Familiar</td><td>${familiar.join(', ')}</td></tr>
          <tr><td>Unfamiliar</td><td>${unfamiliar.join(', ')}</td></tr>
          <tr><td>Trustworthy</td><td>${trustworthy.join(', ')}</td></tr>
          <tr><td>Non-reliable</td><td>${nonReliable.join(', ')}</td></tr>
        </table>
        <p>Seven parts total. Follow instructions carefully.</p>
        <p style="font-style: italic;">· Project Implicit ·</p>
      </div>`,
    choices: [' ']
  };

  const demographics = {
    type: 'survey-html-form',
    html: `
      <p>Gender: <select name="gender" required>
        <option value="">Select</option><option>Male</option><option>Female</option>
        <option>Other</option></select></p>
      <p>Age Group: <select name="age" required>
        <option value="">Select</option><option>20–24</option><option>25–29</option>
        <option>30–34</option><option>35–39</option><option>40+</option></select></p>
      <p>Occupation: <select name="occupation" required>
        <option value="">Select</option><option>Student</option><option>Engineer</option>
        <option>Teacher</option><option>Healthcare Professional</option>
        <option>Business Professional</option><option>Other</option></select></p>
      <p>Education: <select name="education" required>
        <option value="">Select</option><option>High School</option><option>Bachelor's</option>
        <option>Master's</option><option>Doctorate</option><option>Other</option></select></p>
      <p>Ethnicity: <select name="ethnicity" required>
        <option value="">Select</option><option>Hispanic or Latino</option>
        <option>Not Hispanic or Latino</option><option>Prefer not to say</option>
        <option>Other</option></select></p>`,
    button_label: "Continue"
  };

  const errorMessage = () => `<div class="error-message">X = Incorrect, try again</div>`;

 function createTrial(word, correct_side, block) {
  return {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: `<div style="font-size: 2.5em; margin: 3em auto; max-width: 90vw; text-align:center;">${word}</div>
          <div style="display:flex; justify-content: space-between; margin-top: 2em; font-size: 1em;">
            <div><strong>E</strong><br>Left</div>
            <div><strong>I</strong><br>Right</div>
          </div>`,
        choices: ['e', 'i'],
        data: {stimulus: word, correct_side, block, stimType: 'both'},
        on_finish: function(data) {
          data.correct = (data.key === 'e' && correct_side === 'left') || (data.key === 'i' && correct_side === 'right');
        }
      },
      {
        timeline: [{
          type: 'html-keyboard-response',
          stimulus: `<div class="error-message" style="color:red; font-weight:bold; font-size:1.5em; text-align:center;">X = Incorrect, try again</div>`,
          choices: jsPsych.NO_KEYS,
          trial_duration: 700
        }],
        conditional_function: function() {
          const lastData = jsPsych.data.get().last(1).values()[0];
          return !lastData.correct;
        }
      },
      {
        timeline: [], // empty trial to repeat if incorrect
        conditional_function: function() {
          const lastData = jsPsych.data.get().last(2).values()[0];
          return !lastData.correct;
        }
      }
    ],
    loop_function: function(data) {
      return !data[0].correct; // repeat this timeline if incorrect
    }
  };
}


  function makeBlock(c1, c2, a1, a2, label, leftAlign = true) {
    const left = leftAlign ? [...c1, ...a1] : [...c2, ...a2];
    const right = leftAlign ? [...c2, ...a2] : [...c1, ...a1];
    return shuffle([...left.map(w => ({word: w, side: 'left'})),
                    ...right.map(w => ({word: w, side: 'right'}))])
      .map(item => createTrial(item.word, item.side, label));
  }

  const counterbalanceLeft = Math.random() < 0.5;

  const block1 = makeBlock(familiar, unfamiliar, [], [], 'block1');
  const block2 = makeBlock([], [], trustworthy, nonReliable, 'block2');
  const block3 = makeBlock(familiar, unfamiliar, trustworthy, nonReliable, 'block3', counterbalanceLeft);
  const block4 = makeBlock(familiar, unfamiliar, trustworthy, nonReliable, 'block4', counterbalanceLeft);
  const block5 = makeBlock(unfamiliar, familiar, [], [], 'block5');
  const block6 = makeBlock(unfamiliar, familiar, trustworthy, nonReliable, 'block6', !counterbalanceLeft);
  const block7 = makeBlock(unfamiliar, familiar, trustworthy, nonReliable, 'block7', !counterbalanceLeft);

  const instructionText = block => {
    const leftCats = counterbalanceLeft ? 'Familiar or Trustworthy' : 'Unfamiliar or Non-reliable';
    const rightCats = counterbalanceLeft ? 'Unfamiliar or Non-reliable' : 'Familiar or Trustworthy';
    const flipLeftCats = !counterbalanceLeft ? 'Unfamiliar or Trustworthy' : 'Familiar or Non-reliable';
    const flipRightCats = !counterbalanceLeft ? 'Familiar or Non-reliable' : 'Unfamiliar or Trustworthy';
    return {
      1: "Classify brands: Familiar (left) vs Unfamiliar (right).",
      2: "Classify traits: Trustworthy (left) vs Non-reliable (right).",
      3: `Combined: ${leftCats} (left) vs ${rightCats} (right).`,
      4: `Repeat: ${leftCats} (left) vs ${rightCats} (right).`,
      5: "Switch: Unfamiliar (left) vs Familiar (right).",
      6: `Switched combined: ${flipLeftCats} (left) vs ${flipRightCats} (right).`,
      7: `Repeat: ${flipLeftCats} (left) vs ${flipRightCats} (right).`
    }[block];
  };

  const blockTimeline = (num, trials) => [
    { type: 'html-keyboard-response', stimulus: `<p>${instructionText(num)}</p><p>Press any key to begin.</p>` },
    ...trials
  ];

  function computeDScore() {
    const data = jsPsych.data.get().filter({stimType: 'both'});
    const mean = block => {
      const rts = data.filter({block, correct: true}).select('rt').values.filter(rt => rt >= 300 && rt <= 10000);
      return rts.reduce((a, b) => a + b, 0) / rts.length;
    };
    const sdPooled = (b1, b2) => {
      const rts1 = data.filter({block: b1, correct: true}).select('rt').values.filter(rt => rt >= 300 && rt <= 10000);
      const rts2 = data.filter({block: b2, correct: true}).select('rt').values.filter(rt => rt >= 300 && rt <= 10000);
      const all = [...rts1, ...rts2];
      const meanAll = all.reduce((a, b) => a + b, 0) / all.length;
      const variance = all.reduce((sum, rt) => sum + (rt - meanAll) ** 2, 0) / (all.length - 1);
      return Math.sqrt(variance);
    };
    const d1 = (mean('block4') - mean('block3')) / sdPooled('block3', 'block4');
    const d2 = (mean('block7') - mean('block6')) / sdPooled('block6', 'block7');
    return (d1 + d2) / 2;
  }

  const submit_data = {
    type: 'call-function',
    func: function() {
      const demo = jsPsych.data.get().filter({trial_type: 'survey-html-form'}).last(1).values()[0].responses;
      const dScore = computeDScore();
      const payload = {
        demographics: JSON.parse(demo),
        d_score: dScore,
        raw_data: jsPsych.data.get().json()
      };

      console.log('Sending full payload to server:', payload);

      fetch('https://script.google.com/macros/s/AKfycbzjnA81tgjk3feNwADnMpI_ePzquEY9WjuDvlAHNs-okWLcFR4RAp2actklk3zj4vVX3A/exec', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
    }
  };

  const summary = {
    type: 'html-keyboard-response',
    stimulus: () => {
      const d = computeDScore();
      let interp = 'no strong preference detected';
      if (d > 0.2) interp = 'a slight preference for familiar brands';
      else if (d < -0.2) interp = 'a slight preference for unfamiliar brands';
      return `<h3>Thank you!</h3><p>Your results suggest <strong>${interp}</strong>.</p><p>Press any key to finish.</p>`;
    }
  };

  jsPsych.init({
    timeline: [
      welcome, demographics,
      ...blockTimeline(1, block1),
      ...blockTimeline(2, block2),
      ...blockTimeline(3, block3),
      ...blockTimeline(4, block4),
      ...blockTimeline(5, block5),
      ...blockTimeline(6, block6),
      ...blockTimeline(7, block7),
      submit_data,
      summary
    ],
    display_element: document.getElementById('jspsych-target')
  });
})();
</script>
</body>
</html>
